<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Cat Dog Swan Sınıflandırıcı</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 720px; margin: 28px auto; padding: 0 16px; color:#222; }
    h1 { margin-bottom: 6px; }
    #preview { max-width:100%; height:auto; margin-top:12px; display:none; border:1px solid #ddd; }
    #result { margin-top:16px; font-size:16px; }
    .prob { color:#444; font-size:14px; margin-top:6px; }
    ul.probs { padding-left:18px; margin:8px 0 0 0; }
    li { margin:4px 0; }
    .low-confidence { color: #b03; }
  </style>
</head>
<body>
  <h1>Cat / Dog / Swan Sınıflandırıcı</h1>
  <p>Bir görsel yükle; model sınıfını ve olasılıklarını gösterir (Kuğu yerine Swan olarak gösterilir).</p>

  <input type="file" id="fileInput" accept="image/*" />

  <img id="preview" alt="Yüklenen görsel önizleme" />

  <div id="result"></div>

  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.14.0/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8/dist/teachablemachine-image.min.js"></script>

  <script>
    // Teachable Machine hosted model URL (sonunda slash / olmalı)
    const MODEL_URL = "PASTE_YOUR_MODEL_URL_HERE";

    // Label eşleme: modelin döndürdüğü isimleri buraya ekle
    // Örn: modelde "Kuğu" olarak kayıtlıysa -> burada "Kuğu": "Swan" yap
    const labelMap = {
      "Kuğu": "Swan",
      "kuğu": "Swan",
      "Kugu": "Swan",
      "Swan": "Swan" // model zaten Swan döndürse de aynen geçsin
    };

    let model;

    async function loadModel() {
      if (!MODEL_URL || MODEL_URL.includes("PASTE_YOUR_MODEL_URL_HERE")) {
        alert("MODEL_URL değişkenine Teachable Machine model URL'ini yapıştırın.");
        throw new Error("Model URL yok");
      }
      const modelURL = MODEL_URL + "model.json";
      const metadataURL = MODEL_URL + "metadata.json";
      model = await tmImage.load(modelURL, metadataURL);
      console.log("Model yüklendi:", model);
    }

    function showPreview(file) {
      const img = document.getElementById("preview");
      img.src = URL.createObjectURL(file);
      img.style.display = "block";
      return new Promise(resolve => {
        img.onload = () => resolve(img);
      });
    }

    function formatPercent(p) {
      return (p * 100).toFixed(1) + "%";
    }

    // Görünen etiketi al: eğer labelMap'te eşleşme varsa mapped, yoksa orijinal
    function displayLabel(original) {
      return labelMap.hasOwnProperty(original) ? labelMap[original] : original;
    }

    async function predict(imgElement) {
      if (!model) {
        await loadModel();
      }

      const predictions = await model.predict(imgElement);
      const sorted = predictions.slice().sort((a, b) => b.probability - a.probability);
      const best = sorted[0];
      const resultDiv = document.getElementById("result");

      const confidenceThreshold = 0.60;
      const isLow = best.probability < confidenceThreshold;

      resultDiv.innerHTML = `
        <div><strong>En yüksek tahmin:</strong> ${displayLabel(best.className)}</div>
        <div class="prob"><strong>Güven:</strong> ${formatPercent(best.probability)}</div>
        ${isLow ? `<div class="prob low-confidence"><strong>Kararsız:</strong> güven < ${formatPercent(confidenceThreshold)}</div>` : ""}
        <details style="margin-top:8px;">
          <summary><strong>Tüm olasılıklar</strong></summary>
          <ul class="probs">
            ${sorted.map(p => `<li>${displayLabel(p.className)}: ${formatPercent(p.probability)}</li>`).join("")}
          </ul>
        </details>
      `;
    }

    document.getElementById("fileInput").addEventListener("change", async (e) => {
      const file = e.target.files?.[0];
      if (!file) return;
      try {
        if (!model) await loadModel();
        const imgEl = await showPreview(file);
        await predict(imgEl);
      } catch (err) {
        console.error(err);
        alert("Bir hata oluştu. Konsolu kontrol et.");
      }
    });
  </script>
</body>
</html>
